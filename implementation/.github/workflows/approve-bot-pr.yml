name: Approve Bot PRs

on:
  workflow_run:
    workflows: ["Test Pull Request"]
    types:
      - completed

jobs:
  download:
    name: Download PR Artifact
    if: >
      ${{ github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: 'Download artifact'
        uses: paketo-buildpacks/github-config/actions/pull-request/checkout-branch@main
        with:
          name: "event-payload"
          repo: ${{ github.repository }}
          run_id: ${{ github.event.workflow_run.id }},
          workspace: ${{ github.workspace }}

  approve:
    name: Approve Bot PRs
    if: ${{ echo $(cat event.json | jq -r '.pull_request.user.login' | sed s/^v//) == 'paketo-bot' ||
        echo $(cat event.json | jq -r '.pull_request.user.login' | sed s/^v//) == 'dependabot[bot]'}}
    runs-on: ubuntu-latest
    steps:
    - name: Retrieve pull request number
      run: |
        echo "::set-output name=NUMBER::$(cat event.json | jq -r '.pull_request.number')"
      id: pull_request_number

    - name: Check Commit Verification
      id: unverified-commits
      uses: paketo-buildpacks/github-config/actions/pull-request/check-unverified-commits@main
      with:
        token: ${{ secrets.PAKETO_BOT_REVIEWER_GITHUB_TOKEN }}
        repo: ${{ github.repository }}
        # TODO: do we have access to the number in another way?
        number: ${{ steps.pull_request_number.outputs.NUMBER }}

    - name: Check for Human Commits
      id: human-commits
      uses: paketo-buildpacks/github-config/actions/pull-request/check-human-commits@main
      with:
        token: ${{ secrets.PAKETO_BOT_REVIEWER_GITHUB_TOKEN }}
        repo: ${{ github.repository }}
        number: ${{ steps.pull_request_number.outputs.NUMBER }}

    - name: Checkout
      if: steps.human-commits.outputs.human_commits == 'false' && steps.unverified-commits.outputs.unverified_commits == 'false'
      uses: actions/checkout@v2

    - name: Approve
      if: steps.human-commits.outputs.human_commits == 'false' && steps.unverified-commits.outputs.unverified_commits == 'false'
      uses: paketo-buildpacks/github-config/actions/pull-request/approve@main
      with:
        token: ${{ secrets.PAKETO_BOT_REVIEWER_GITHUB_TOKEN }}
        number: ${{ steps.pull_request_number.outputs.NUMBER }}
